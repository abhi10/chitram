# Chitram Production Docker Compose
# ==================================
#
# Usage:
#   1. Copy .env.production.example to .env.production
#   2. Fill in secure values in .env.production
#   3. Run: docker compose --env-file .env.production up -d
#
# For local development/testing with default values:
#   docker compose up -d
#
# Access points (production with Caddy):
#   - Web UI:  https://${DOMAIN}
#   - API:     https://${DOMAIN}/api/v1
#   - Health:  https://${DOMAIN}/health
#
# Access points (local without Caddy):
#   - Web UI:  http://localhost:8000
#   - API:     http://localhost:8000/api/v1

services:
  # ===========================================================================
  # APPLICATION
  # ===========================================================================
  app:
    build:
      context: ../backend
      dockerfile: Dockerfile
    expose:
      - "8000"
    # For local testing without Caddy, uncomment:
    # ports:
    #   - "8000:8000"
    environment:
      # Database
      DATABASE_URL: ${DATABASE_URL:-postgresql+asyncpg://chitram:localdev@postgres:5432/chitram}

      # Storage (MinIO)
      STORAGE_BACKEND: minio
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-minio:9000}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      MINIO_BUCKET: ${MINIO_BUCKET:-images}
      MINIO_SECURE: ${MINIO_SECURE:-false}

      # Redis Cache
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      CACHE_ENABLED: ${CACHE_ENABLED:-true}
      CACHE_TTL_SECONDS: ${CACHE_TTL_SECONDS:-3600}
      CACHE_KEY_PREFIX: ${CACHE_KEY_PREFIX:-chitram}

      # Rate Limiting
      RATE_LIMIT_ENABLED: ${RATE_LIMIT_ENABLED:-true}
      RATE_LIMIT_PER_MINUTE: ${RATE_LIMIT_PER_MINUTE:-30}
      RATE_LIMIT_WINDOW_SECONDS: ${RATE_LIMIT_WINDOW_SECONDS:-60}

      # Upload Settings
      UPLOAD_CONCURRENCY_LIMIT: ${UPLOAD_CONCURRENCY_LIMIT:-10}
      MAX_FILE_SIZE_BYTES: ${MAX_FILE_SIZE_BYTES:-5242880}

      # Authentication
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-dev-secret-change-in-production}
      JWT_ACCESS_TOKEN_EXPIRE_MINUTES: ${JWT_ACCESS_TOKEN_EXPIRE_MINUTES:-1440}

      # Auth Provider (Phase 3.5)
      AUTH_PROVIDER: ${AUTH_PROVIDER:-local}
      SUPABASE_URL: ${SUPABASE_URL:-}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY:-}

      # App Settings
      DEBUG: ${DEBUG:-false}
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 3
    networks:
      - chitram-network

  # ===========================================================================
  # REVERSE PROXY (Caddy - automatic HTTPS)
  # ===========================================================================
  caddy:
    image: caddy:2-alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    environment:
      DOMAIN: ${DOMAIN:-localhost}
    depends_on:
      - app
    restart: unless-stopped
    networks:
      - chitram-network

  # ===========================================================================
  # DATABASE (PostgreSQL)
  # ===========================================================================
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-chitram}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-localdev}
      POSTGRES_DB: ${POSTGRES_DB:-chitram}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    # Expose only if explicitly configured (for external access/debugging)
    # ports:
    #   - "${EXPOSE_POSTGRES_PORT:-5433}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-chitram} -d ${POSTGRES_DB:-chitram}"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - chitram-network

  # ===========================================================================
  # OBJECT STORAGE (MinIO)
  # ===========================================================================
  minio:
    image: minio/minio:latest
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    volumes:
      - minio-data:/data
    command: server /data --console-address ":9001"
    # Expose only if explicitly configured (for external access/debugging)
    # ports:
    #   - "${EXPOSE_MINIO_API_PORT:-9002}:9000"
    #   - "${EXPOSE_MINIO_CONSOLE_PORT:-9003}:9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - chitram-network

  # MinIO bucket initialization (runs once)
  minio-init:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
      MINIO_BUCKET: ${MINIO_BUCKET:-images}
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 $${MINIO_ROOT_USER} $${MINIO_ROOT_PASSWORD};
      mc mb myminio/$${MINIO_BUCKET} --ignore-existing;
      mc anonymous set public myminio/$${MINIO_BUCKET};
      echo 'Bucket $${MINIO_BUCKET} initialized successfully';
      "
    networks:
      - chitram-network

  # ===========================================================================
  # CACHE (Redis)
  # ===========================================================================
  redis:
    image: redis:7-alpine
    volumes:
      - redis-data:/data
    # Use password if configured
    command: >
      sh -c '
      if [ -n "$${REDIS_PASSWORD}" ]; then
        redis-server --appendonly yes --requirepass "$${REDIS_PASSWORD}"
      else
        redis-server --appendonly yes
      fi
      '
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
    # Expose only if explicitly configured
    # ports:
    #   - "${EXPOSE_REDIS_PORT:-6380}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - chitram-network

# =============================================================================
# VOLUMES (Persistent Data)
# =============================================================================
volumes:
  postgres-data:
    name: chitram-postgres-data
  minio-data:
    name: chitram-minio-data
  redis-data:
    name: chitram-redis-data
  caddy-data:
    name: chitram-caddy-data
  caddy-config:
    name: chitram-caddy-config

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  chitram-network:
    name: chitram-network
    driver: bridge
