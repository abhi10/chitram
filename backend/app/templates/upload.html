{% extends "base.html" %}

{% block title %}Upload{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="font-display text-3xl font-semibold text-gray-800 mb-2">
            Upload Image
        </h1>
        <p class="text-gray-600">
            Share your image with the world. JPEG and PNG supported, max 5MB.
        </p>
    </div>

    <!-- Upload Form -->
    <form
        id="upload-form"
        action="/api/v1/images/upload"
        method="POST"
        enctype="multipart/form-data"
        class="bg-white rounded-2xl shadow-sm border border-cream-300 p-6"
    >
        <!-- Drag & Drop Zone -->
        <div
            id="drop-zone"
            class="border-2 border-dashed border-cream-300 rounded-xl p-8 text-center cursor-pointer transition-colors hover:border-terracotta-400 hover:bg-cream-50"
            onclick="document.getElementById('file-input').click()"
        >
            <div id="drop-zone-content">
                <div class="text-5xl mb-4">üì∑</div>
                <p class="text-gray-700 font-medium mb-1">
                    Drop your image here or click to browse
                </p>
                <p class="text-gray-500 text-sm">
                    JPEG or PNG, max 5MB
                </p>
            </div>

            <!-- Preview (hidden initially) -->
            <div id="preview-container" class="hidden">
                <img id="preview-image" src="" alt="Preview" class="max-h-64 mx-auto rounded-lg">
                <p id="preview-filename" class="mt-3 text-gray-700 font-medium"></p>
                <button
                    type="button"
                    onclick="clearPreview(event)"
                    class="mt-2 text-gray-500 hover:text-red-500 text-sm transition-colors"
                >
                    Remove
                </button>
            </div>
        </div>

        <input
            type="file"
            id="file-input"
            name="file"
            accept="image/jpeg,image/png"
            class="hidden"
            onchange="handleFileSelect(this)"
            required
        >

        <!-- Error Message -->
        <div id="error-message" class="hidden mt-4 p-3 bg-red-50 border border-red-200 text-red-700 rounded-lg text-sm">
        </div>

        <!-- Submit Button -->
        <button
            type="submit"
            id="submit-btn"
            class="w-full mt-6 bg-terracotta-500 text-white py-3 px-4 rounded-lg font-medium hover:bg-terracotta-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2"
            disabled
        >
            <span id="submit-text">Upload Image</span>
            <svg id="submit-spinner" class="hidden animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </button>

        {% if not user %}
        <!-- Anonymous Upload Warning -->
        <div class="mt-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
            <div class="flex items-start space-x-3">
                <span class="text-xl">‚ö†Ô∏è</span>
                <div class="text-sm">
                    <p class="text-amber-800 font-medium">Anonymous Upload</p>
                    <p class="text-amber-700 mt-1">
                        You're not logged in. You'll receive a delete token after upload - save it to delete your image later.
                    </p>
                    <p class="mt-2">
                        <a href="/login" class="text-terracotta-600 hover:underline">Login</a> or
                        <a href="/register" class="text-terracotta-600 hover:underline">Register</a>
                        to manage your images easily.
                    </p>
                </div>
            </div>
        </div>
        {% endif %}
    </form>
</div>

<script>
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const form = document.getElementById('upload-form');
    const submitBtn = document.getElementById('submit-btn');
    const errorMessage = document.getElementById('error-message');

    // Drag and drop handlers
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        dropZone.classList.add('border-terracotta-500', 'bg-cream-50');
    }

    function unhighlight(e) {
        dropZone.classList.remove('border-terracotta-500', 'bg-cream-50');
    }

    dropZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFileSelect(fileInput);
        }
    }

    function handleFileSelect(input) {
        const file = input.files[0];
        if (!file) return;

        // Validate file type
        if (!['image/jpeg', 'image/png'].includes(file.type)) {
            showError('Please select a JPEG or PNG image.');
            return;
        }

        // Validate file size (5MB)
        if (file.size > 5 * 1024 * 1024) {
            showError('File size must be less than 5MB.');
            return;
        }

        hideError();

        // Show preview
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('preview-image').src = e.target.result;
            document.getElementById('preview-filename').textContent = file.name;
            document.getElementById('drop-zone-content').classList.add('hidden');
            document.getElementById('preview-container').classList.remove('hidden');
        };
        reader.readAsDataURL(file);

        // Enable submit button
        submitBtn.disabled = false;
    }

    function clearPreview(e) {
        e.stopPropagation();
        fileInput.value = '';
        document.getElementById('drop-zone-content').classList.remove('hidden');
        document.getElementById('preview-container').classList.add('hidden');
        submitBtn.disabled = true;
        hideError();
    }

    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.remove('hidden');
        fileInput.value = '';
        submitBtn.disabled = true;
    }

    function hideError() {
        errorMessage.classList.add('hidden');
    }

    // Form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(form);

        // Show loading state
        submitBtn.disabled = true;
        document.getElementById('submit-text').textContent = 'Uploading...';
        document.getElementById('submit-spinner').classList.remove('hidden');

        try {
            const response = await fetch('/api/v1/images/upload', {
                method: 'POST',
                body: formData,
            });

            const data = await response.json();

            if (response.ok) {
                // Check if anonymous upload (has delete_token)
                if (data.delete_token) {
                    // Store token and redirect to success page
                    sessionStorage.setItem('delete_token', data.delete_token);
                    sessionStorage.setItem('image_id', data.id);
                }
                // Redirect to image detail
                window.location.href = '/image/' + data.id;
            } else {
                showError(data.detail?.message || 'Upload failed. Please try again.');
                resetSubmitButton();
            }
        } catch (error) {
            showError('Network error. Please try again.');
            resetSubmitButton();
        }
    });

    function resetSubmitButton() {
        submitBtn.disabled = false;
        document.getElementById('submit-text').textContent = 'Upload Image';
        document.getElementById('submit-spinner').classList.add('hidden');
    }
</script>
{% endblock %}
