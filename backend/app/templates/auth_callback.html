{% extends "base.html" %}

{% block title %}Authenticating...{% endblock %}

{% block content %}
<div class="max-w-md mx-auto text-center">
    <div class="bg-white rounded-2xl shadow-sm border border-cream-300 p-8">
        <!-- Loading State -->
        <div id="loading-state">
            <svg class="animate-spin h-12 w-12 mx-auto text-terracotta-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <h2 class="font-display text-xl font-semibold text-gray-800 mb-2">
                Completing sign in...
            </h2>
            <p class="text-gray-600">
                Please wait while we finish authenticating you.
            </p>
        </div>

        <!-- Error State (hidden by default) -->
        <div id="error-state" class="hidden">
            <svg class="h-12 w-12 mx-auto text-red-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h2 class="font-display text-xl font-semibold text-gray-800 mb-2">
                Authentication Failed
            </h2>
            <p id="error-message" class="text-gray-600 mb-4">
                Something went wrong during sign in.
            </p>
            <a href="/login" class="inline-block bg-terracotta-500 text-white py-2 px-4 rounded-lg font-medium hover:bg-terracotta-600 transition-colors">
                Try Again
            </a>
        </div>
    </div>
</div>

<script>
    // Extract token from URL hash and set cookie
    async function handleCallback() {
        const loadingState = document.getElementById('loading-state');
        const errorState = document.getElementById('error-state');
        const errorMessage = document.getElementById('error-message');

        function showError(message) {
            loadingState.classList.add('hidden');
            errorState.classList.remove('hidden');
            errorMessage.textContent = message;
        }

        try {
            // Check if Supabase client is available
            if (!window.supabase) {
                showError('Authentication service not available');
                return;
            }

            // Get session from Supabase (it handles the hash parsing)
            const { data, error } = await window.supabase.auth.getSession();

            if (error) {
                showError(error.message);
                return;
            }

            if (!data.session) {
                // No session yet, try to exchange the code/token
                // Supabase JS client should handle this automatically from URL hash
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                const accessToken = hashParams.get('access_token');

                if (accessToken) {
                    // Set the cookie with the access token
                    document.cookie = `chitram_auth=${accessToken}; path=/; max-age=${60*60*24*7}; SameSite=Strict`;
                    window.location.href = '/';
                    return;
                }

                // Check URL params for error
                const urlParams = new URLSearchParams(window.location.search);
                const errorDesc = urlParams.get('error_description');
                if (errorDesc) {
                    showError(decodeURIComponent(errorDesc));
                    return;
                }

                showError('No authentication data received');
                return;
            }

            // We have a session - set the cookie
            const accessToken = data.session.access_token;
            document.cookie = `chitram_auth=${accessToken}; path=/; max-age=${60*60*24*7}; SameSite=Strict`;

            // Redirect to home
            window.location.href = '/';

        } catch (err) {
            console.error('Auth callback error:', err);
            showError('An unexpected error occurred');
        }
    }

    // Run on page load
    handleCallback();
</script>
{% endblock %}
